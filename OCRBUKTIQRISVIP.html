<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SHORTCUT VIP - Ekstraktor Bukti Transfer & Penggabung Gambar</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 fill=%22%234361ee%22>âš¡</text></svg>">
<style>
/* ======= VARIABEL WARNA ======= */
:root {
  --primary: #4361ee;
  --secondary: #3a0ca3;
  --accent: #f72585;
  --text: #212529;
  --text-light: #f8f9fa;
  --bg: #f8f9fa;
  --card-bg: #ffffff;
  --card-shadow: rgba(0, 0, 0, 0.1);
  --input-bg: #ffffff;
  --border: #dee2e6;
  --success: #4caf50;
  --error: #f44336;
  --warning: #ff9800;
  --info: #2196f3;
  --progress-bg: #e9ecef;
  --progress-bar: #4361ee;
  --dark-bg: #121212;
  --dark-card: #1e1e1e;
  --dark-text: #e0e0e0;
  --dark-border: #333333;
  --dark-input: #2d2d2d;
  --dark-shadow: rgba(0, 0, 0, 0.4);
  
  /* Variabel untuk penggabung gambar */
  --primary-green: #1e7a4c;
  --primary-light: #3a9e7d;
  --secondary-green: #3a9e7d;
  --accent-yellow: #ffca28;
}

/* ======= STYLING UMUM ======= */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  transition: background-color 0.3s, color 0.3s;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), 
              url('https://cdn.areabermain.club/assets/cdn/az6/2025/04/01/20250401/5dc9d083e18085eef7c0cd7fcf52bd46/linetogel-bg-new.jpg') no-repeat center center fixed;
  background-size: cover;
  min-height: 100vh;
  padding: 20px;
  color: var(--text-light);
}

body.dark-mode {
  background: linear-gradient(rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.8)), 
              url('https://cdn.areabermain.club/assets/cdn/az6/2025/04/01/20250401/5dc9d083e18085eef7c0cd7fcf52bd46/linetogel-bg-new.jpg') no-repeat center center fixed;
  background-size: cover;
  color: var(--dark-text);
}

.container {
  max-width: 800px;
  margin: 0 auto;
}

/* ======= HEADER ======= */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.header-content {
  flex-grow: 1;
}

h1 {
  font-size: 2.0rem;
  color: white;
  text-align: center;
  margin-bottom: 8px;
  text-shadow: 0 2px 4px rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

h1 i {
  background: linear-gradient(45deg, var(--accent), var(--primary));
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* ======= TAB NAVIGASI ======= */
.tabs-container {
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.tab-btn {
  flex: 1;
  min-width: 180px;
  padding: 12px 15px;
  background: linear-gradient(135deg, #252525, #2a2a2a);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-light);
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

body.dark-mode .tab-btn {
  border-color: var(--dark-border);
}

.tab-btn:hover {
  background: linear-gradient(135deg, #2e2e2e, #222222);
}

.tab-btn.active {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  border-color: var(--primary);
}

.tab-content {
  display: none;
  animation: fadeIn 0.5s ease;
}

.tab-content.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ======= KARTU & FORM ======= */
.card {
  background-color: rgba(255, 255, 255, 0.9);
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
  margin-bottom: 20px;
  border: 1px solid var(--border);
  backdrop-filter: blur(5px);
}

body.dark-mode .card {
  background-color: rgba(30, 30, 30, 0.85);
  box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
  border-color: var(--dark-border);
}

.form-group {
  margin-bottom: 15px;
  position: relative;
}

label {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
  color: var(--primary);
  font-size: 0.9rem;
}

body.dark-mode label {
  color: #bb86fc;
}

.input-container {
  position: relative;
}

input, select {
  width: 100%;
  padding: 10px 40px 10px 12px;
  border: 2px solid var(--border);
  border-radius: 8px;
  font-size: 14px;
  background-color: var(--input-bg);
  transition: all 0.3s;
  box-sizing: border-box;
  color: var(--text);
}

body.dark-mode input, 
body.dark-mode select {
  background-color: var(--dark-input);
  border-color: var(--dark-border);
  color: var(--dark-text);
}

input:focus, select:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
  outline: none;
}

.clear-btn {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: #777;
  cursor: pointer;
  font-size: 14px;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.2s;
}

.clear-btn:hover {
  background-color: #f0f0f0;
  color: #ff4d4d;
}

body.dark-mode .clear-btn:hover {
  background-color: #333;
}

.upload-container {
  border: 2px dashed var(--border);
  border-radius: 8px;
  padding: 10px;
  text-align: center;
  cursor: pointer;
  margin-top: 10px;
  transition: all 0.3s;
  background-color: rgba(255, 255, 255, 0.8);
}

body.dark-mode .upload-container {
  border-color: var(--dark-border);
  background-color: rgba(45, 45, 45, 0.6);
}

.upload-container:hover {
  border-color: var(--primary);
  background-color: rgba(67, 97, 238, 0.1);
}

.upload-container i {
  font-size: 24px;
  color: var(--primary);
  margin-bottom: 4px;
}

.upload-container p {
  font-size: 12px;
  color: #666;
  margin-bottom: 3px;
}

body.dark-mode .upload-container p {
  color: #aaa;
}

.upload-container span {
  font-size: 10px;
  color: #999;
}

/* ======= PREVIEW GAMBAR ======= */
#preview-container {
  margin-top: 15px;
  text-align: center;
  border-radius: 8px;
  overflow: hidden;
  max-width: 100%;
  display: none;
  position: relative;
}

#preview {
  max-width: 100%;
  max-height: 150px;
  border-radius: 6px;
  background-color: white;
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
  cursor: pointer;
  transition: transform 0.3s;
}

body.dark-mode #preview {
  background-color: #2d2d2d;
}

.preview-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s;
  border-radius: 6px;
}

#preview-container:hover .preview-overlay {
  opacity: 1;
}

.preview-overlay i {
  font-size: 30px;
  color: white;
  text-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

/* ======= HASIL EKSTRAKSI ======= */
.result {
  margin-top: 20px;
  padding: 15px;
  background-color: rgba(255, 255, 255, 0.9);
  border-radius: 12px;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease;
  border-left: 3px solid var(--primary);
  backdrop-filter: blur(5px);
}

body.dark-mode .result {
  background-color: rgba(30, 30, 30, 0.85);
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.25);
}

.result:hover {
  transform: translateY(-2px);
}

.result h3 {
  color: var(--primary);
  margin-top: 0;
  margin-bottom: 15px;
  padding-bottom: 8px;
  border-bottom: 2px solid var(--border);
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 1.2rem;
}

body.dark-mode .result h3 {
  border-color: var(--dark-border);
}

.result-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.result-item {
  margin-bottom: 0;
}

.result-label {
  font-weight: 600;
  color: var(--primary);
  display: block;
  margin-bottom: 4px;
  font-size: 0.85rem;
  display: flex;
  align-items: center;
  gap: 6px;
}

.result-value {
  background-color: rgba(67, 97, 238, 0.08);
  padding: 10px 12px;
  border-radius: 8px;
  font-size: 14px;
  border: 1px solid rgba(67, 97, 238, 0.2);
  display: flex;
  justify-content: space-between;
  align-items: center;
  min-height: 40px;
  color: var(--text);
  transition: all 0.3s;
}

body.dark-mode .result-value {
  background-color: rgba(67, 97, 238, 0.15);
  border-color: rgba(67, 97, 238, 0.3);
  color: var(--dark-text);
}

.copy-btn {
  background: none;
  border: none;
  color: var(--primary);
  cursor: pointer;
  padding: 6px;
  font-size: 14px;
  border-radius: 6px;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 30px;
  height: 30px;
}

.copy-btn:hover {
  background-color: rgba(67, 97, 238, 0.1);
  transform: scale(1.1);
}

body.dark-mode .copy-btn {
  color: #bb86fc;
}

body.dark-mode .copy-btn:hover {
  background-color: rgba(187, 134, 252, 0.1);
}

/* ======= LOADING ======= */
#loading {
  text-align: center;
  margin: 15px 0;
  display: none;
  background-color: rgba(255, 255, 255, 0.9);
  padding: 15px;
  border-radius: 10px;
  border: 1px solid var(--border);
  backdrop-filter: blur(5px);
  color: var(--text);
}

body.dark-mode #loading {
  background-color: rgba(30, 30, 30, 0.85);
  border-color: var(--dark-border);
  color: var(--dark-text);
}

.progress-container {
  width: 100%;
  height: 6px;
  background-color: var(--progress-bg);
  border-radius: 3px;
  margin-top: 10px;
  overflow: hidden;
}

body.dark-mode .progress-container {
  background-color: #333;
}

.progress-bar {
  height: 100%;
  background: linear-gradient(to right, var(--primary), var(--accent));
  border-radius: 3px;
  width: 0%;
  transition: width 0.3s ease;
}

/* ======= TOMBOL AKSI ======= */
.action-buttons {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}

.btn {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.btn-primary {
  background: linear-gradient(to right, var(--primary), var(--secondary));
  color: white;
  box-shadow: 0 3px 6px rgba(67, 97, 238, 0.2);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(67, 97, 238, 0.3);
}

.btn-secondary {
  background: rgba(0, 0, 0, 0.05);
  color: var(--text);
  border: 1px solid var(--border);
  box-shadow: 0 3px 6px rgba(0,0,0,0.05);
}

body.dark-mode .btn-secondary {
  background: rgba(255, 255, 255, 0.05);
  color: var(--dark-text);
  border-color: var(--dark-border);
}

.btn-secondary:hover {
  background: rgba(0, 0, 0, 0.1);
}

body.dark-mode .btn-secondary:hover {
  background: rgba(255, 255, 255, 0.1);
}

/* ======= TOGGLE TEMA ======= */
.theme-toggle {
  background: rgba(255, 255, 255, 0.25);
  border: none;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: white;
  font-size: 16px;
  transition: all 0.3s;
  backdrop-filter: blur(10px);
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
}

.theme-toggle:hover {
  background: rgba(255, 255, 255, 0.35);
  transform: rotate(15deg);
}

/* ======= PREVIEW MODAL ======= */
#imagePreviewModal {
  display: none;
  position: fixed;
  z-index: 1000;
  padding-top: 40px;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.9);
}

#imagePreviewModal img {
  margin: auto;
  display: block;
  max-width: 80%;
  max-height: 80%;
  border: 2px solid white;
  border-radius: 6px;
  box-shadow: 0 0 15px rgba(0,0,0,0.5);
}

#closePreview {
  position: absolute;
  top: 12px;
  right: 25px;
  color: #f1f1f1;
  font-size: 36px;
  font-weight: bold;
  transition: 0.3s;
  cursor: pointer;
  text-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

#closePreview:hover,
#closePreview:focus {
  color: #bbb;
  text-decoration: none;
}

/* ======= NOTIFIKASI ======= */
.copy-notification {
  position: fixed;
  top: 15px;
  right: 15px;
  background: var(--success);
  color: white;
  padding: 10px 15px;
  border-radius: 6px;
  z-index: 1000;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  display: flex;
  align-items: center;
  gap: 8px;
  opacity: 0;
  transform: translateY(-20px);
  transition: opacity 0.3s, transform 0.3s;
}

.copy-notification.show {
  opacity: 1;
  transform: translateY(0);
}

.copy-notification i {
  font-size: 16px;
}

/* ======= ANIMASI ======= */
@keyframes copyPulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

.copy-success {
  animation: copyPulse 0.5s ease;
}

@keyframes flashAnimation {
  0% { background-color: rgba(76, 175, 80, 0.1); }
  50% { background-color: rgba(76, 175, 80, 0.4); }
  100% { background-color: initial; }
}

.copy-flash {
  animation: flashAnimation 1s ease;
}

/* ======= FITUR PENGGABUNG GAMBAR ======= */
.panel {
  background: linear-gradient(135deg, #1e1e1e, #2a2a2a);
  backdrop-filter: blur(10px);
  border-radius: 10px;
  padding: 15px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
  border: 1px solid var(--border);
  margin-bottom: 15px;
}

body.dark-mode .panel {
  background: linear-gradient(135deg, #1e1e1e, #2a2a2a);
  border-color: var(--dark-border);
}

.panel-title {
  font-size: 1.1rem;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 2px solid var(--primary-light);
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--secondary-green);
  font-weight: 600;
}

.panel-title i {
  color: var(--accent-yellow);
}

.url-input-section {
  margin-bottom: 15px;
}

.url-input-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.url-input-header h3 {
  color: #e0ffe0;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.95rem;
}

.supported-services {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 8px;
}

.service-badge {
  background: rgba(30, 122, 76, 0.2);
  border: 1px solid var(--primary-light);
  border-radius: 15px;
  padding: 4px 10px;
  font-size: 0.75rem;
  display: flex;
  align-items: center;
  gap: 4px;
  color: #c0ffd0;
  font-weight: 500;
}

body.dark-mode .service-badge {
  background: rgba(30, 122, 76, 0.3);
  border-color: var(--primary-light);
}

.url-input-group {
  display: flex;
  margin-bottom: 12px;
}

.url-input-group input {
  flex: 1;
  padding: 10px 15px;
  border: none;
  border-radius: 8px 0 0 8px;
  background: rgba(20, 36, 26, 0.7);
  color: var(--text-light);
  font-size: 0.9rem;
  border: 1px solid var(--border);
  font-weight: 500;
}

body.dark-mode .url-input-group input {
  background: rgba(20, 36, 26, 0.8);
  border-color: var(--dark-border);
}

.url-input-group input::placeholder {
  color: rgba(200, 255, 220, 0.6);
}

.url-input-group input:focus {
  outline: none;
  border-color: var(--primary-light);
  box-shadow: 0 0 0 2px rgba(58, 158, 125, 0.3);
}

.url-input-group button {
  padding: 10px 15px;
  background: var(--primary-green);
  color: white;
  border: none;
  border-radius: 0 8px 8px 0;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  gap: 6px;
  border: 1px solid var(--border);
  border-left: none;
  font-weight: 600;
  font-size: 0.9rem;
}

.url-input-group button:hover {
  background: var(--primary-light);
}

body.dark-mode .url-input-group button {
  background: var(--primary-green);
  border-color: var(--dark-border);
}

body.dark-mode .url-input-group button:hover {
  background: var(--primary-light);
}

/* ======= UPLOAD GAMBAR UNTUK PENGGABUNG ======= */
.upload-section {
  margin-bottom: 15px;
}

.upload-section h3 {
  color: #e0ffe0;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.95rem;
  margin-bottom: 8px;
}

.merger-upload-container {
  border: 2px dashed var(--border);
  border-radius: 8px;
  padding: 10px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
  background-color: rgba(30, 46, 40, 0.7);
  margin-top: 8px;
}

body.dark-mode .merger-upload-container {
  background-color: rgba(30, 46, 40, 0.8);
  border-color: var(--dark-border);
}

.merger-upload-container:hover {
  border-color: var(--primary-light);
  background-color: rgba(58, 158, 125, 0.2);
}

.merger-upload-container i {
  font-size: 24px;
  color: var(--primary-light);
  margin-bottom: 4px;
}

.merger-upload-container p {
  font-size: 12px;
  color: #c0ffd0;
  margin-bottom: 3px;
}

.merger-upload-container span {
  font-size: 10px;
  color: #a0e0b0;
}

.settings {
  margin: 15px 0;
}

.setting-group {
  margin-bottom: 12px;
}

.setting-group label {
  display: block;
  margin-bottom: 6px;
  font-weight: 500;
  color: #e0ffe0;
  font-size: 0.9rem;
}

.setting-group select, .setting-group input {
  width: 100%;
  padding: 10px 12px;
  border-radius: 6px;
  background: rgba(20, 36, 26, 0.7);
  color: var(--text-light);
  border: 1px solid var(--border);
  font-weight: 500;
  font-size: 0.9rem;
}

body.dark-mode .setting-group select, 
body.dark-mode .setting-group input {
  background: rgba(20, 36, 26, 0.8);
  border-color: var(--dark-border);
}

.setting-group select:focus, .setting-group input:focus {
  outline: none;
  border-color: var(--primary-light);
  box-shadow: 0 0 0 2px rgba(58, 158, 125, 0.3);
}

.quality-control {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-top: 8px;
}

.quality-value {
  min-width: 35px;
  text-align: center;
  font-weight: bold;
  color: var(--accent-yellow);
  font-size: 0.9rem;
}

.preview-container {
  margin-top: 15px;
}

.counter {
  margin-bottom: 10px;
  font-size: 0.9rem;
  background: rgba(30, 46, 40, 0.7);
  padding: 8px 12px;
  border-radius: 20px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  color: #c0ffd0;
  font-weight: 500;
}

body.dark-mode .counter {
  background: rgba(30, 46, 40, 0.8);
}

.image-previews {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  gap: 10px;
  min-height: 120px;
}

.preview-item {
  position: relative;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25);
  transition: all 0.3s;
  aspect-ratio: 1/1;
  border: 1px solid var(--border);
}

body.dark-mode .preview-item {
  border-color: var(--dark-border);
}

.preview-item:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
  border-color: var(--primary-light);
}

.preview-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.preview-item .remove-btn {
  position: absolute;
  top: 6px;
  right: 6px;
  background: rgba(239, 83, 80, 0.8);
  color: white;
  border: none;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  cursor: pointer;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
  font-size: 12px;
}

.result-container {
  text-align: center;
  margin-top: 20px;
  min-height: 200px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 15px;
  background: rgba(30, 46, 40, 0.7);
  border-radius: 8px;
  border: 1px dashed var(--border);
}

body.dark-mode .result-container {
  background: rgba(30, 46, 40, 0.8);
  border-color: var(--dark-border);
}

#resultImage {
  max-width: 100%;
  max-height: 250px;
  border-radius: 8px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
  display: none;
  border: 1px solid var(--border);
  cursor: pointer;
  transition: transform 0.3s;
}

#resultImage:hover {
  transform: scale(1.02);
}

.placeholder {
  color: rgba(200, 255, 220, 0.7);
  font-style: italic;
  padding: 20px;
  text-align: center;
  font-weight: 500;
  line-height: 1.6;
  font-size: 0.9rem;
}

.link-container {
  margin-top: 15px;
  width: 100%;
  background: rgba(30, 46, 40, 0.7);
  border-radius: 8px;
  padding: 15px;
  display: none;
  animation: fadeIn 0.5s ease;
}

body.dark-mode .link-container {
  background: rgba(30, 46, 40, 0.8);
}

.link-container h4 {
  margin-bottom: 10px;
  font-size: 1.0rem;
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--secondary-green);
  font-weight: 600;
}

.image-link {
  display: flex;
  gap: 8px;
}

.image-link input {
  flex: 1;
  padding: 10px 12px;
  border-radius: 6px;
  border: none;
  background: rgba(20, 36, 26, 0.7);
  color: var(--text-light);
  font-size: 0.85rem;
  border: 1px solid var(--border);
  font-weight: 500;
}

body.dark-mode .image-link input {
  background: rgba(20, 36, 26, 0.8);
  border-color: var(--dark-border);
}

.image-link button {
  padding: 10px 15px;
  background: var(--primary-green);
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.3s;
  display: flex;
  align-items: center;
  gap: 6px;
  border: 1px solid var(--border);
  font-weight: 600;
  font-size: 0.85rem;
}

.image-link button:hover {
  background: var(--primary-light);
}

body.dark-mode .image-link button {
  background: var(--primary-green);
  border-color: var(--dark-border);
}

body.dark-mode .image-link button:hover {
  background: var(--primary-light);
}

.download-btn {
  margin-top: 15px;
  padding: 12px 20px;
  background: linear-gradient(to right, var(--primary-green), var(--secondary-green));
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 0.9rem;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  gap: 8px;
  display: none;
  border: 1px solid var(--border);
  font-weight: 600;
}

.download-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 12px rgba(0, 0, 0, 0.3);
}

body.dark-mode .download-btn {
  border-color: var(--dark-border);
}

/* ======= LOADER ======= */
#mergerLoader {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(18, 18, 18, 0.9);
  z-index: 9999;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 12px;
}

.loader-content {
  text-align: center;
}

.loader-spinner {
  width: 40px;
  height: 40px;
  border: 3px solid rgba(212, 175, 55, 0.1);
  border-radius: 50%;
  border-top-color: var(--accent-yellow);
  animation: spin 1s ease-in-out infinite;
  margin: 0 auto;
}

.loader-text {
  margin-top: 8px;
  color: var(--accent-yellow);
  font-size: 12px;
  font-weight: 500;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* ======= LIGHTBOX ======= */
.lightbox {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.95);
  z-index: 2000;
  overflow: auto;
  text-align: center;
}

.lightbox-content {
  margin: 5% auto;
  max-width: 90%;
  max-height: 85%;
  display: block;
  box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.close-btn {
  position: absolute;
  top: 15px;
  right: 25px;
  color: #f1f1f1;
  font-size: 35px;
  font-weight: bold;
  transition: 0.3s;
  cursor: pointer;
  z-index: 2001;
}

.close-btn:hover {
  color: #bbb;
  text-decoration: none;
}

/* ======= RESPONSIVE ======= */
@media (max-width: 992px) {
  .container {
    padding: 15px;
  }
  
  .tabs-container {
    flex-direction: column;
  }
  
  .tab-btn {
    min-width: 100%;
  }
}

@media (max-width: 768px) {
  .header {
    padding: 15px;
  }
  
  h1 {
    font-size: 1.6rem;
  }
  
  .card, .panel {
    padding: 15px;
  }
  
  .url-input-group {
    flex-direction: column;
  }
  
  .url-input-group input {
    border-radius: 8px;
    margin-bottom: 8px;
  }
  
  .url-input-group button {
    border-radius: 8px;
    width: 100%;
  }
  
  .action-buttons {
    flex-direction: column;
  }
  
  .image-previews {
    grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
  }
  
  .download-btn {
    width: 100%;
  }
}

@media (max-width: 480px) {
  h1 {
    font-size: 1.4rem;
  }
  
  .btn {
    width: 100%;
    justify-content: center;
  }
  
  .image-previews {
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
  }
  
  .result-container {
    padding: 12px;
  }
  
  .panel-title {
    font-size: 1.0rem;
  }
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="header-content">
      <h1><i class="fas fa-bolt"></i> SHORTCUT VIP </h1>
      <p style="text-align: center; color: #4361ee; font-weight: 500; margin-top: 3px; font-size: 0.9rem;">Ekstraktor Bukti Transfer & Penggabung Gambar</p>
    </div>
    <button class="theme-toggle" id="themeToggle">
      <i class="fas fa-moon"></i>
    </button>
  </div>

  <!-- Tab Navigasi -->
  <div class="tabs-container">
    <button class="tab-btn active" data-tab="extractor-app">
      <i class="fas fa-file-invoice"></i> Ekstraktor
    </button>
    <button class="tab-btn" data-tab="merger-app">
      <i class="fas fa-object-group"></i> Gabung Gambar
    </button>
  </div>
  
  <!-- Tab: Ekstraktor Bukti Transfer -->
  <div id="extractor-app" class="tab-content active">
    <div class="card">
      <div class="form-group">
        <label for="userId"><i class="fas fa-user"></i> User ID:</label>
        <div class="input-container">
          <input type="text" id="userId" placeholder="Masukkan User ID">
          <button class="clear-btn" id="clearUserId">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>

      <div class="form-group">
        <label for="imageUrl"><i class="fas fa-link"></i> URL Gambar Bukti:</label>
        <div class="input-container">
          <input type="text" id="imageUrl" placeholder="Tempel URL gambar bukti transfer">
          <button class="clear-btn" id="clearImageUrl">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>

      <div class="upload-container" id="uploadContainer">
        <i class="fas fa-cloud-upload-alt"></i>
        <p>Unggah Gambar Bukti Transfer</p>
        <span>Klik untuk memilih file (JPG, PNG, maks 5MB)</span>
        <input type="file" id="fileInput" accept="image/*" style="display: none;">
      </div>

      <div class="form-group">
        <label for="bankSelect"><i class="fas fa-university"></i> Pilih Jenis Bank:</label>
        <select id="bankSelect">
          <option value="DANA">DANA</option>
          <option value="BRI">BRI</option>
          <option value="BCA">BCA</option>
          <option value="BNI">BNI</option>
          <option value="MANDIRI">Mandiri</option>
        </select>
      </div>

      <!-- Preview Container -->
      <div id="preview-container">
        <img id="preview" alt="Preview Gambar">
        <div class="preview-overlay">
          <i class="fas fa-search-plus"></i>
        </div>
      </div>

      <div class="action-buttons">
        <button id="processButton" class="btn btn-primary">
          <i class="fas fa-cogs"></i> Proses Gambar
        </button>
        <button id="resetButton" class="btn btn-secondary">
          <i class="fas fa-redo"></i> Reset Form
        </button>
      </div>

      <div id="loading">
        <p><i class="fas fa-sync fa-spin"></i> Sedang memproses gambar... Harap tunggu</p>
        <div class="progress-container">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        <p id="progressStatus">Menginisialisasi...</p>
      </div>
    </div>

    <div class="card result" id="results">
      <h3><i class="fas fa-file-invoice"></i> Hasil Ekstraksi</h3>
      <div class="result-list">
        <div class="result-item">
          <span class="result-label"><i class="fas fa-store"></i> Nama Merchant/Toko:</span>
          <div class="result-value">
            <span id="merchantName">-</span>
            <button class="copy-btn" onclick="copyToClipboard('merchantName')">
              <i class="far fa-copy"></i>
            </button>
          </div>
        </div>
        <div class="result-item">
          <span class="result-label"><i class="fas fa-hashtag"></i> Nomor Referensi (RRN):</span>
          <div class="result-value">
            <span id="rrn">-</span>
            <button class="copy-btn" onclick="copyToClipboard('rrn')">
              <i class="far fa-copy"></i>
            </button>
          </div>
        </div>
        <div class="result-item">
          <span class="result-label"><i class="fas fa-money-bill-wave"></i> Total:</span>
          <div class="result-value">
            <span id="totalAmount">-</span>
            <button class="copy-btn" onclick="copyToClipboard('totalAmount')">
              <i class="far fa-copy"></i>
            </button>
          </div>
        </div>
        <div class="result-item">
          <span class="result-label"><i class="fas fa-user"></i> User ID:</span>
          <div class="result-value">
            <span id="resultUserId">-</span>
            <button class="copy-btn" onclick="copyToClipboard('resultUserId')">
              <i class="far fa-copy"></i>
            </button>
          </div>
        </div>
        <div class="result-item">
          <span class="result-label"><i class="fas fa-link"></i> URL Gambar:</span>
          <div class="result-value">
            <span id="imageUrlResult">-</span>
            <button class="copy-btn" onclick="copyToClipboard('imageUrlResult')">
              <i class="far fa-copy"></i>
            </button>
          </div>
        </div>
        <div class="result-item">
          <span class="result-label"><i class="fas fa-landmark"></i> Jenis Bank:</span>
          <div class="result-value">
            <span id="selectedBank">-</span>
            <button class="copy-btn" onclick="copyToClipboard('selectedBank')">
              <i class="far fa-copy"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Tab: Penggabung Gambar -->
  <div id="merger-app" class="tab-content">
    <div class="panel">
      <h2 class="panel-title">
        <i class="fas fa-cogs"></i> Input & Pengaturan
      </h2>
      
      <div class="url-input-section">
        <div class="url-input-group">
          <input type="text" id="mergerImageUrl" placeholder="https://prnt.sc/... atau https://sleekshot.app/...">
          <button id="addUrlBtn">
            <i class="fas fa-plus"></i> Tambah
          </button>
        </div>
        
        <div class="supported-services">
          <span class="service-badge">
            <i class="fas fa-check-circle"></i> prnt.sc
          </span>
          <span class="service-badge">
            <i class="fas fa-check-circle"></i> sleekshot.app
          </span>
          <span class="service-badge">
            <i class="fas fa-check-circle"></i> imghostr.com
          </span>
          <span class="service-badge">
            <i class="fas fa-check-circle"></i> imgur.com
          </span>
          <span class="service-badge">
            <i class="fas fa-check-circle"></i> gambar langsung
          </span>
        </div>
      </div>
      
      <!-- Upload Gambar untuk Penggabung -->
      <div class="upload-section">
        <h3><i class="fas fa-upload"></i> Unggah Gambar</h3>
        <div class="merger-upload-container" id="mergerUploadContainer">
          <i class="fas fa-cloud-upload-alt"></i>
          <p>Unggah Gambar untuk Digabungkan</p>
          <span>Klik untuk memilih file (JPG, PNG, maks 5MB)</span>
          <input type="file" id="mergerFileInput" accept="image/*" multiple style="display: none;">
        </div>
      </div>
      
      <div class="settings">
        <h2 class="panel-title">
          <i class="fas fa-sliders-h"></i> Pengaturan Gabungan
        </h2>
        
        <div class="setting-group">
          <label for="layout">Tata Letak Gambar:</label>
          <select id="layout">
            <option value="horizontal">Horizontal (Sejajar)</option>
            <option value="vertical">Vertikal (Bertumpuk)</option>
            <option value="grid2">Grid 2 Kolom</option>
            <option value="grid3">Grid 3 Kolom</option>
          </select>
        </div>
        
        <div class="setting-group">
          <label for="spacing">Jarak Antar Gambar:</label>
          <select id="spacing">
            <option value="0" selected>0px</option>
            <option value="5">5px</option>
            <option value="10">10px</option>
            <option value="15">15px</option>
            <option value="20">20px</option>
          </select>
        </div>
        
        <div class="setting-group">
          <label for="background">Latar Belakang:</label>
          <select id="background">
            <option value="transparent">Transparan</option>
            <option value="white" selected>Putih</option>
            <option value="black">Hitam</option>
          </select>
        </div>
        
        <div class="setting-group">
          <label>Kualitas Gambar:</label>
          <div class="quality-control">
            <input type="range" id="quality" min="50" max="100" value="100">
            <span class="quality-value" id="qualityValue">100%</span>
          </div>
        </div>
      </div>
      
      <div class="action-buttons">
        <button id="mergeBtn" class="btn btn-primary">
          <i class="fas fa-object-group"></i> Gabungkan Gambar
        </button>
        <button id="resetBtn" class="btn btn-secondary" style="color: white; background: rgba(239, 83, 80, 0.8);">
          <i class="fas fa-trash-alt"></i> Reset
        </button>
      </div>
    </div>
    
    <div class="panel">
      <h2 class="panel-title">
        <i class="fas fa-images"></i> Preview & Hasil
      </h2>
      
      <div class="preview-container">
        <div class="counter">
          <i class="fas fa-layer-group"></i> Gambar Terpilih: <span id="imageCount">0</span>/10
        </div>
        
        <div class="image-previews" id="previewContainer">
          <!-- Preview gambar akan muncul di sini -->
        </div>
      </div>
      
      <div class="merger-loader" id="mergerLoader" style="display: none;">
        <div class="loader-content">
          <div class="loader-spinner"></div>
          <div class="loader-text">MEMPROSES GAMBAR...</div>
        </div>
      </div>
      
      <div class="result-container" id="resultContainer">
        <p class="placeholder">Hasil gabungan gambar akan muncul di sini<br>Klik pada gambar untuk memperbesar</p>
        <img id="resultImage" alt="Hasil gabungan gambar">
        
        <div class="link-container" id="linkContainer">
          <h4><i class="fas fa-link"></i> Link Gambar Hasil Gabungan:</h4>
          <div class="image-link">
            <input type="text" id="imageLink" readonly>
            <button id="copyLinkBtn">
              <i class="fas fa-copy"></i> Salin
            </button>
          </div>
        </div>
        
        <button id="downloadBtn" class="download-btn">
          <i class="fas fa-download"></i> Unduh Gambar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal untuk preview gambar -->
<div id="imagePreviewModal">
  <span id="closePreview">&times;</span>
  <img id="previewImage" alt="Bukti Transfer">
</div>

<!-- Lightbox untuk tampilan gambar besar -->
<div id="lightbox" class="lightbox">
  <span class="close-btn">&times;</span>
  <img class="lightbox-content" id="lightboxImg">
</div>

<div class="copy-notification" id="copyNotification">
  <i class="fas fa-check-circle"></i> <span id="notificationText">Teks telah disalin!</span>
</div>

<script>
// ======= VARIABEL GLOBAL =======
let currentProcessId = 0;
let isProcessing = false;
let uploadedImageUrl = null;
let currentImageUrl = null;

// Untuk fitur penggabung gambar
let images = [];
let mergedImageData = null;

// ======= FUNGSI UMUM =======

// Fungsi untuk memvalidasi URL gambar
function isValidImageUrl(url) {
  return /\.(jpe?g|png|gif|bmp|webp)$/i.test(url) || 
         /^https?:\/\/.+(?:jpe?g|png|gif|bmp|webp)/i.test(url) ||
         url.startsWith('data:image');
}

// Fungsi untuk membersihkan angka (hapus karakter non-digit)
function cleanNumber(text) {
  return text.replace(/[^\d]/g, '');
}

// Fungsi untuk memformat mata uang
function formatCurrency(amount) {
  const num = parseInt(amount);
  if (isNaN(num)) return 'Rp 0';
  
  return 'Rp ' + num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

// Fungsi untuk menampilkan notifikasi
function showNotification(message, isError = false) {
  const notification = document.getElementById('copyNotification');
  const notificationText = document.getElementById('notificationText');
  
  if (isError) {
    notification.style.background = 'var(--error)';
    notificationText.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
  } else {
    notification.style.background = 'var(--success)';
    notificationText.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
  }
  
  notification.classList.add('show');
  
  setTimeout(() => {
    notification.classList.remove('show');
  }, 3000);
}

// Fungsi untuk memproses nominal khusus BCA (hilangkan .00)
function processBCAAmount(amountStr) {
  // Hapus semua karakter non-digit kecuali koma dan titik
  let cleaned = amountStr.replace(/[^\d,.]/g, '');
  
  // Hapus desimal .00 atau ,00 jika ada di akhir
  cleaned = cleaned.replace(/(\.|,)\d{2}$/, '');
  
  // Hapus semua titik (pemisah ribuan)
  cleaned = cleaned.replace(/\./g, '').replace(',', '');
  
  return cleaned;
}

// Fungsi untuk memproses nominal bank lain
function processAmount(amountStr) {
  // Hapus semua karakter non-digit kecuali koma dan titik
  let cleaned = amountStr.replace(/[^\d,.]/g, '');
  
  // Jika ada koma sebagai pemisah desimal, ambil hanya bagian bulat
  if (cleaned.includes(',')) {
    cleaned = cleaned.split(',')[0];
  }
  
  // Hapus semua titik (pemisah ribuan)
  cleaned = cleaned.replace(/\./g, '');
  
  return cleaned;
}

// Fungsi untuk memberi efek visual pada kolom yang disalin
function flashCopyEffect(element) {
  // Reset animasi sebelumnya
  element.classList.remove('copy-flash');
  
  // Trigger reflow
  void element.offsetWidth;
  
  // Tambahkan kelas animasi
  element.classList.add('copy-flash');
}

// Fungsi untuk menyalin teks ke clipboard
function copyToClipboard(elementId) {
  const element = document.getElementById(elementId);
  if (!element) return;
  
  let textToCopy = element.textContent;
  let fieldName = "Teks";

  // Untuk imageUrlResult, gunakan URL lengkap dari data attribute
  if (elementId === 'imageUrlResult' && element.hasAttribute('data-full-url')) {
    textToCopy = element.getAttribute('data-full-url');
  }
  // Untuk totalAmount, gunakan nilai bersih jika ada
  else if (elementId === 'totalAmount' && element.hasAttribute('data-clean')) {
    textToCopy = element.getAttribute('data-clean');
  }
  
  // Tentukan nama field yang disalin
  switch(elementId) {
    case 'resultUserId': fieldName = "User ID"; break;
    case 'merchantName': fieldName = "Nama Merchant"; break;
    case 'totalAmount': fieldName = "Total Pembayaran"; break;
    case 'rrn': fieldName = "Nomor Referensi"; break;
    case 'selectedBank': fieldName = "Jenis Bank"; break;
    case 'imageUrlResult': fieldName = "URL Gambar"; break;
  }

  navigator.clipboard.writeText(textToCopy).then(() => {
    // Tambahkan animasi ke tombol salin
    const copyButton = element.nextElementSibling;
    if (copyButton) {
      copyButton.classList.add('copy-success');
      setTimeout(() => {
        copyButton.classList.remove('copy-success');
      }, 500);
    }
    
    // Dapatkan elemen result-value untuk efek flash
    const resultValueElement = element.closest('.result-value');
    if (resultValueElement) {
      flashCopyEffect(resultValueElement);
    }
    
    showNotification(`<strong>${fieldName}</strong> berhasil disalin!`);
  }).catch(err => {
    console.error('Gagal menyalin teks: ', err);
    // Fallback untuk browser lama
    const textarea = document.createElement('textarea');
    textarea.value = textToCopy;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    
    // Dapatkan elemen result-value untuk efek flash
    const resultValueElement = element.closest('.result-value');
    if (resultValueElement) {
      flashCopyEffect(resultValueElement);
    }
    
    showNotification(`<strong>${fieldName}</strong> berhasil disalin!`);
  });
}

// ======= FUNGSI EKSTRAKTOR BUKTI TRANSFER =======

// Fungsi utama untuk memproses gambar
async function processImage() {
  let imageUrl = document.getElementById('imageUrl').value;
  
  if (!imageUrl && uploadedImageUrl) {
    imageUrl = uploadedImageUrl;
  }
  
  const userId = document.getElementById('userId').value;
  const bankSelect = document.getElementById('bankSelect');
  const loading = document.getElementById('loading');
  const progressBar = document.getElementById('progressBar');
  const progressStatus = document.getElementById('progressStatus');
  const previewContainer = document.getElementById('preview-container');
  const preview = document.getElementById('preview');

  if (!imageUrl) {
    showNotification('Silakan masukkan URL gambar atau unggah gambar terlebih dahulu', true);
    return;
  }

  if (!userId) {
    showNotification('Silakan masukkan User ID terlebih dahulu', true);
    return;
  }

  if (!isValidImageUrl(imageUrl)) {
    showNotification('URL gambar tidak valid. Pastikan URL berakhir dengan ekstensi gambar (.jpg, .png, dll)', true);
    return;
  }
  
  currentImageUrl = imageUrl;
  
  if (preview) {
    preview.src = imageUrl;
    previewContainer.style.display = 'block';
  }
  
  isProcessing = true;
  const processId = ++currentProcessId;

  loading.style.display = 'block';
  if (progressBar) progressBar.style.width = '0%';
  if (progressStatus) progressStatus.textContent = 'Menginisialisasi...';

  try {
    const { data: { text } } = await Tesseract.recognize(
      imageUrl,
      'eng+ind',
      {
        logger: m => {
          if (processId !== currentProcessId) return;

          if (m.status === 'recognizing text') {
            const progress = Math.min(100, Math.round(m.progress * 100));
            if (progressBar) progressBar.style.width = `${progress}%`;
            if (progressStatus) progressStatus.textContent = `Memproses: ${progress}%`;
          }
        }
      }
    );

    if (processId !== currentProcessId) return;

    extractDataFromText(text, bankSelect.value);
    if (document.getElementById('resultUserId')) {
      document.getElementById('resultUserId').textContent = userId;
    }
    if (document.getElementById('selectedBank')) {
      document.getElementById('selectedBank').textContent = bankSelect.value;
    }
    
    if (document.getElementById('imageUrlResult')) {
      let displayUrl = imageUrl;
      if (imageUrl.length > 50) {
        displayUrl = imageUrl.substring(0, 25) + '...' + imageUrl.substring(imageUrl.length - 25);
      }
      document.getElementById('imageUrlResult').textContent = displayUrl;
      document.getElementById('imageUrlResult').setAttribute('data-full-url', imageUrl);
    }

    showNotification('Gambar berhasil diproses!');

  } catch (error) {
    if (processId !== currentProcessId) return;

    console.error('Error processing image:', error);
    showNotification('Gagal memproses gambar: ' + error.message, true);
  } finally {
    if (processId !== currentProcessId) return;

    if (loading) loading.style.display = 'none';
    isProcessing = false;
  }
}

// Fungsi untuk mengekstrak data dari teks hasil OCR
function extractDataFromText(text, bankType) {
  let merchantName = 'Tidak ditemukan';
  let totalAmount = 'Tidak ditemukan';
  let rrn = 'Tidak ditemukan';

  console.log("Teks yang diekstrak dari gambar:", text);

  if (bankType === 'DANA') {
    const merchantMatch = text.match(/Pembayaran\s+ke\s+([^\n\u2022-]+)/i);
    const amountMatch = text.match(/(?:Total\s*Bayar|Total)\s*Rp\s*([\d.,]+)/i) ||
                       text.match(/Rp\s*([\d.,]+)(?=\s*(?:Dana|Bayar|Total))/i);
    const rrnQrisMatch = text.match(/RRN\s*QRIS\s*([^\s\n]+)/i);
    const rrnMatch = text.match(/RRN\s*[:]?\s*(\d+)/i) ||
                     text.match(/Ref\s*[:]?\s*(\d+)/i);

    merchantName = merchantMatch ? merchantMatch[1].trim() : merchantName;
    rrn = rrnQrisMatch ? rrnQrisMatch[1].trim() : (rrnMatch ? rrnMatch[1].trim() : rrn);

    if (amountMatch) {
      const amountValue = processAmount(amountMatch[1]);
      if (amountValue && !isNaN(parseInt(amountValue))) {
        totalAmount = formatCurrency(amountValue);
        const totalElement = document.getElementById('totalAmount');
        if (totalElement) {
          totalElement.setAttribute('data-clean', amountValue);
          totalElement.textContent = totalAmount;
        }
      }
    }

  } else if (bankType === 'BRI') {
    const merchantMatch = text.match(/Nama\s+Merchant\s+([^\n]+)/i);
    const amountMatch = text.match(/Nominal\s+Rp\s*([\d.,]+)/i) ||
                       text.match(/Total\s+Rp\s*([\d.,]+)/i);
    const rrnMatch = text.match(/Nomor\s+Referensi\s+(\d{6,})/i) ||
                     text.match(/RRN\s*[:]?\s*(\d+)/i);

    merchantName = merchantMatch ? merchantMatch[1].trim() : merchantName;
    rrn = rrnMatch ? rrnMatch[1].trim() : rrn;

    if (amountMatch) {
      const amountValue = processAmount(amountMatch[1]);
      if (amountValue && !isNaN(parseInt(amountValue))) {
        totalAmount = formatCurrency(amountValue);
        const totalElement = document.getElementById('totalAmount');
        if (totalElement) {
          totalElement.setAttribute('data-clean', amountValue);
          totalElement.textContent = totalAmount;
        }
      }
    }

  } else if (bankType === 'BCA') {
    // 1. Merchant Name: Ambil di atas nomor transaksi
    const transaksiMatch = text.match(/No\.?\s*Transaksi\s*[:]?\s*([^\n]+)/i);
    if (transaksiMatch) {
      const lines = text.split('\n');
      const index = lines.findIndex(line => line.includes(transaksiMatch[0]));
      if (index > 0) {
        merchantName = lines[index - 1].trim();
      }
    }
    
    // 2. RRN: Ambil nomor RRN
    const rrnMatch = text.match(/RRN\s*[:]?\s*(\d{6,})/i) ||
                     text.match(/Ref(?:erence)?\s*[:]?\s*(\d{6,})/i);
    rrn = rrnMatch ? rrnMatch[1].trim() : rrn;

    // 3. PERBAIKAN KHUSUS UNTUK TOTAL BCA: Ambil nominal dengan pembulatan
    // Cari semua kemunculan Rp. diikuti angka
    const amountMatches = [...text.matchAll(/Rp\.?\s*([\d.,]+)/gi)];
    
    if (amountMatches.length > 0) {
      // Ekstrak angka dari setiap match dan konversi ke number
      const amounts = amountMatches.map(match => {
        // Proses khusus untuk BCA: hilangkan desimal .00
        const cleaned = processBCAAmount(match[1]);
        return parseInt(cleaned) || 0;
      });
      
      // Cari nilai maksimum (biasanya total transfer)
      const maxAmount = Math.max(...amounts);
      
      if (maxAmount > 0) {
        // Format ulang untuk ditampilkan (tanpa desimal)
        totalAmount = 'Rp' + maxAmount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        
        const totalElement = document.getElementById('totalAmount');
        if (totalElement) {
          totalElement.setAttribute('data-clean', maxAmount.toString());
          totalElement.textContent = totalAmount;
        }
      }
    }
    
    // Jika tidak ditemukan, coba pendekatan alternatif
    if (totalAmount === 'Tidak ditemukan') {
      const lines = text.split('\n');
      
      // Cari baris yang mengandung "DARI"
      const dariIndex = lines.findIndex(line => line.includes('DARI'));
      if (dariIndex > 0) {
        const amountLine = lines[dariIndex - 1];
        const match = amountLine.match(/Rp\.?\s*([\d.,]+)/i);
        if (match) {
          // Proses khusus untuk BCA: hilangkan desimal .00
          const cleaned = processBCAAmount(match[1]);
          const amountValue = parseInt(cleaned) || 0;
          
          if (amountValue > 0) {
            totalAmount = 'Rp' + amountValue.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            
            const totalElement = document.getElementById('totalAmount');
            if (totalElement) {
              totalElement.setAttribute('data-clean', amountValue.toString());
              totalElement.textContent = totalAmount;
            }
          }
        }
      }
    }
  } else if (bankType === 'BNI') {
    const merchantMatch = text.match(/Nama\s+Merchant\s+([^\n]+)/i);
    const amountMatch = text.match(/Nominal\s+Bayar\s+Rp\s*([\d.]+)(?:,|$)/i) ||
                       text.match(/Total\s+Rp\s*([\d.]+)(?:,|$)/i);
    const rrnMatch = text.match(/Reff\s+ID\/RRN\s+([^\n]+)/i) ||
                     text.match(/RRN\s*[:]?\s*(\d+)/i);

    merchantName = merchantMatch ? merchantMatch[1].trim() : merchantName;
    rrn = rrnMatch ? rrnMatch[1].trim() : rrn;

    if (amountMatch) {
      const amountValue = processAmount(amountMatch[1]);
      if (amountValue && !isNaN(parseInt(amountValue))) {
        totalAmount = formatCurrency(amountValue);
        const totalElement = document.getElementById('totalAmount');
        if (totalElement) {
          totalElement.setAttribute('data-clean', amountValue);
          totalElement.textContent = totalAmount;
        }
      }
    }
  } else if (bankType === 'MANDIRI') {
    const lines = text.split('\n');
    let merchantFound = false;
    let rrnFound = false;
    let totalFound = false;

    // PERBAIKAN KHUSUS: CARI BERDASARKAN "ID" DAN AMBIL BARIS DI ATASNYA
    for (let i = 0; i < lines.length; i++) {
      // Cari baris yang mengandung "ID" (bisa berupa "ID Transaksi", "ID Pembayaran", dll)
      if (lines[i].match(/\bID\b/i)) {
        // Ambil baris sebelumnya sebagai merchant
        if (i - 1 >= 0) {
          merchantName = lines[i - 1].trim();
          merchantFound = true;
          break;
        }
      }
    }

    // Jika belum ditemukan, coba dengan pola "Detail Transaksi"
    if (!merchantFound) {
      for (let i = 0; i < lines.length; i++) {
        if (lines[i].toLowerCase().includes('detail transaksi')) {
          // Ambil 2 baris di atasnya
          if (i - 2 >= 0) {
            merchantName = lines[i - 2].trim();
            merchantFound = true;
            break;
          }
        }
      }
    }

    // Jika masih belum ditemukan, coba dengan pola lama (di bawah "Penerima")
    if (!merchantFound) {
      for (let i = 0; i < lines.length; i++) {
        if (lines[i].toLowerCase().includes('penerima')) {
          // Langsung ambil baris berikutnya sebagai merchant
          if (i + 1 < lines.length) {
            merchantName = lines[i + 1].trim();
            merchantFound = true;
            break;
          }
        }
      }
    }

    // 2. Cari Nomor Referensi (dari "No. referensi qris")
    const rrnQrisMatch = text.match(/No\.?\s*referensi\s*qris\s*[:]?\s*([^\s\n]+)/i);
    if (rrnQrisMatch) {
      rrn = rrnQrisMatch[1].trim();
      rrnFound = true;
    }

    // 3. Cari Total Transaksi (setelah kata "total")
    for (let i = 0; i < lines.length; i++) {
      if (lines[i].match(/\btotal\b/i)) {
        // Cari di baris yang sama
        const sameLineMatch = lines[i].match(/Rp\s*([\d.,]+)/i);
        if (sameLineMatch) {
          const amountValue = processAmount(sameLineMatch[1]);
          if (amountValue) {
            totalAmount = formatCurrency(amountValue);
            totalFound = true;
            break;
          }
        }
        
        // Coba baris berikutnya jika tidak ditemukan
        if (!totalFound && i + 1 < lines.length) {
          const nextLineMatch = lines[i + 1].match(/Rp\s*([\d.,]+)/i);
          if (nextLineMatch) {
            const amountValue = processAmount(nextLineMatch[1]);
            if (amountValue) {
              totalAmount = formatCurrency(amountValue);
              totalFound = true;
              break;
            }
          }
        }
      }
    }

    // Fallback jika tidak ditemukan dengan pola khusus
    if (!rrnFound) {
      const rrnMatch = text.match(/RRN\s*[:]?\s*(\d+)/i) ||
                       text.match(/Nomor\s+Referensi\s+(\d+)/i);
      rrn = rrnMatch ? rrnMatch[1].trim() : rrn;
    }
    
    if (!totalFound) {
      const amountMatch = text.match(/Total\s*[:]?\s*Rp\s*([\d.,]+)/i) ||
                         text.match(/Nominal\s+Rp\s*([\d.,]+)/i);
      if (amountMatch) {
        const amountValue = processAmount(amountMatch[1]);
        if (amountValue) {
          totalAmount = formatCurrency(amountValue);
        }
      }
    }
  }

  // Set hasil ke elemen
  if (document.getElementById('merchantName')) {
    document.getElementById('merchantName').textContent = merchantName;
  }
  if (document.getElementById('rrn')) {
    document.getElementById('rrn').textContent = rrn;
  }
  if (document.getElementById('totalAmount')) {
    if (totalAmount !== 'Tidak ditemukan') {
      const amountValue = processAmount(totalAmount.replace('Rp ', ''));
      document.getElementById('totalAmount').setAttribute('data-clean', amountValue);
      document.getElementById('totalAmount').textContent = totalAmount;
    } else {
      document.getElementById('totalAmount').textContent = totalAmount;
      document.getElementById('totalAmount').removeAttribute('data-clean');
    }
  }
}

// ======= FUNGSI PENGGABUNG GAMBAR =======

// Fungsi untuk mengekstrak URL gambar sebenarnya dari berbagai layanan
async function extractImageUrl(url) {
  try {
    // Untuk layanan prnt.sc
    if (url.includes('prnt.sc')) {
      // Coba ambil dari meta og:image
      const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
      const data = await response.json();
      const html = data.contents;
      
      // Metode 1: Cari meta property og:image
      const ogImageRegex = /<meta\s+property="og:image"\s+content="([^"]+)"/i;
      const ogMatch = ogImageRegex.exec(html);
      if (ogMatch && ogMatch[1]) {
        return ogMatch[1].replace(/&amp;/g, '&');
      }
      
      // Metode 2: Cari gambar dengan class khusus
      const classRegex = /<img[^>]+class="[^"]*screenshot-image[^"]*"[^>]+src="([^">]+)"/i;
      const classMatches = classRegex.exec(html);
      if (classMatches && classMatches[1]) {
        return classMatches[1].startsWith('//') ? 'https:' + classMatches[1] : classMatches[1];
      }
      
      return url;
    }
    
    // Untuk layanan sleekshot.app
    if (url.includes('sleekshot.app')) {
      const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
      const data = await response.json();
      const html = data.contents;
      const ogImageRegex = /<meta\s+property="og:image"\s+content="([^">]+)"/i;
      const matches = ogImageRegex.exec(html);
      if (matches && matches[1]) {
        return matches[1];
      }
      return url;
    }
    
    // Untuk layanan imghostr.com
    if (url.includes('imghostr.com')) {
      // Coba ekstrak ID gambar dari URL (contoh: https://imghostr.com/66e5d9_wl61 -> ID:66e5d9)
      const idMatch = url.match(/imghostr\.com\/([a-zA-Z0-9]+)_/);
      if (idMatch && idMatch[1]) {
        return `https://img.imghostr.com/${idMatch[1]}.png`;
      }
      
      // Jika tidak berhasil, coba parsing HTML
      const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
      const data = await response.json();
      const html = data.contents;
      const imgRegex = /<img[^>]+id="image-view"[^>]+src="([^">]+)"/i;
      const matches = imgRegex.exec(html);
      if (matches && matches[1]) {
        return matches[1];
      }
      return url;
    }
    
    // Untuk imgur.com
    if (url.includes('imgur.com')) {
      // Konversi URL gallery ke direct image
      if (url.includes('/gallery/') || url.includes('/a/')) {
        const idMatch = url.match(/\/([a-zA-Z0-9]+)$/);
        if (idMatch && idMatch[1]) {
          return `https://i.imgur.com/${idMatch[1]}.jpg`;
        }
      }
      return url;
    }
    
    // Untuk URL langsung
    return url;
  } catch (error) {
    console.error('Extraction error:', error);
    return url;
  }
}

// Fungsi untuk memperbarui preview gambar
function updatePreviews() {
  const previewContainer = document.getElementById('previewContainer');
  previewContainer.innerHTML = '';
  
  images.forEach((image, index) => {
    const previewItem = document.createElement('div');
    previewItem.className = 'preview-item';
    
    const img = document.createElement('img');
    img.src = image.src;
    img.alt = `Preview ${index + 1}`;
    
    const removeBtn = document.createElement('button');
    removeBtn.className = 'remove-btn';
    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
    removeBtn.onclick = () => removeImage(index);
    
    previewItem.appendChild(img);
    previewItem.appendChild(removeBtn);
    previewContainer.appendChild(previewItem);
  });
  
  document.getElementById('imageCount').textContent = images.length;
  
  // Disable tombol gabungkan jika tidak ada gambar
  document.getElementById('mergeBtn').disabled = images.length === 0;
}

// Fungsi untuk menghapus gambar
function removeImage(index) {
  images.splice(index, 1);
  updatePreviews();
  showNotification('Gambar dihapus', 'info');
}

// Fungsi untuk menggabungkan gambar
async function mergeImages() {
  if (images.length === 0) {
    showNotification('Tidak ada gambar untuk digabungkan!', 'error');
    return;
  }
  
  // Tampilkan loader
  const loader = document.getElementById('mergerLoader');
  loader.style.display = 'block';
  const resultContainer = document.getElementById('resultContainer');
  resultContainer.style.display = 'none';
  
  try {
    // Sembunyikan placeholder
    const placeholder = resultContainer.querySelector('.placeholder');
    if (placeholder) placeholder.style.display = 'none';
    
    // Buat canvas untuk penggabungan
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // Dapatkan pengaturan
    const layout = document.getElementById('layout').value;
    const spacing = parseInt(document.getElementById('spacing').value);
    const background = document.getElementById('background').value;
    const quality = parseInt(document.getElementById('quality').value) / 100;
    
    // Preload semua gambar
    const imgElements = await Promise.all(images.map(imageData => {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.src = imageData.src;
      });
    }));
    
    // Hitung dimensi canvas
    let canvasWidth = 0;
    let canvasHeight = 0;
    
    if (layout === 'horizontal') {
      canvasWidth = imgElements.reduce((sum, img) => sum + img.width, 0) + 
                   spacing * (imgElements.length - 1);
      canvasHeight = Math.max(...imgElements.map(img => img.height));
    } else if (layout === 'vertical') {
      canvasWidth = Math.max(...imgElements.map(img => img.width));
      canvasHeight = imgElements.reduce((sum, img) => sum + img.height, 0) + 
                    spacing * (imgElements.length - 1);
    } else {
      const columns = layout === 'grid2' ? 2 : 3;
      const rows = Math.ceil(imgElements.length / columns);
      
      let maxWidths = Array(columns).fill(0);
      let maxHeights = Array(rows).fill(0);
      
      imgElements.forEach((img, i) => {
        const col = i % columns;
        const row = Math.floor(i / columns);
        
        if (img.width > maxWidths[col]) maxWidths[col] = img.width;
        if (img.height > maxHeights[row]) maxHeights[row] = img.height;
      });
      
      canvasWidth = maxWidths.reduce((sum, w) => sum + w, 0) + 
                   spacing * (columns - 1);
      canvasHeight = maxHeights.reduce((sum, h) => sum + h, 0) + 
                    spacing * (rows - 1);
    }
    
    // Set ukuran canvas
    canvas.width = canvasWidth;
    canvas.height = canvasHeight;
    
    // Isi background
    if (background === 'white') {
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, canvasWidth, canvasHeight);
    } else if (background === 'black') {
      ctx.fillStyle = '#000000';
      ctx.fillRect(0, 0, canvasWidth, canvasHeight);
    }
    
    // Gambar semua gambar di canvas
    let x = 0;
    let y = 0;
    
    imgElements.forEach((img, i) => {
      if (layout === 'horizontal') {
        ctx.drawImage(img, x, 0);
        x += img.width + spacing;
      } else if (layout === 'vertical') {
        ctx.drawImage(img, 0, y);
        y += img.height + spacing;
      } else {
        const columns = layout === 'grid2' ? 2 : 3;
        const col = i % columns;
        const row = Math.floor(i / columns);
        
        // Cari lebar maks kolom sebelumnya
        let offsetX = 0;
        for (let c = 0; c < col; c++) {
          let maxW = 0;
          for (let r = row * columns; r < (row + 1) * columns; r++) {
            if (r < imgElements.length && imgElements[r].width > maxW) {
              maxW = imgElements[r].width;
            }
          }
          offsetX += maxW + spacing;
        }
        
        // Cari tinggi maks baris sebelumnya
        let offsetY = 0;
        for (let r = 0; r < row; r++) {
          let maxH = 0;
          for (let c = 0; c < columns; c++) {
            const idx = r * columns + c;
            if (idx < imgElements.length && imgElements[idx].height > maxH) {
              maxH = imgElements[idx].height;
            }
          }
          offsetY += maxH + spacing;
        }
        
        ctx.drawImage(img, offsetX, offsetY);
      }
    });
    
    // Konversi canvas ke data URL dengan kualitas yang dipilih
    const format = background === 'transparent' ? 'image/png' : 'image/jpeg';
    mergedImageData = canvas.toDataURL(format, quality);
    
    // Tampilkan hasil
    const resultImage = document.getElementById('resultImage');
    resultImage.src = mergedImageData;
    resultImage.style.display = 'block';
    document.getElementById('downloadBtn').style.display = 'block';
    
    // Tampilkan link gambar
    const imageLink = document.getElementById('imageLink');
    imageLink.value = mergedImageData;
    document.getElementById('linkContainer').style.display = 'block';
    
    // Tampilkan kembali kontainer hasil
    resultContainer.style.display = 'flex';
    
    showNotification('Gambar berhasil digabungkan! Klik pada gambar untuk memperbesar.', 'success');
  } catch (error) {
    console.error('Merge error:', error);
    showNotification('Terjadi kesalahan saat menggabungkan gambar.', 'error');
  } finally {
    // Sembunyikan loader
    loader.style.display = 'none';
  }
}

// Fungsi untuk mengunduh gambar
function downloadImage() {
  if (!mergedImageData) return;
  
  const link = document.createElement('a');
  link.href = mergedImageData;
  const background = document.getElementById('background').value;
  link.download = `gabungan-gambar-${new Date().getTime()}.${background === 'transparent' ? 'png' : 'jpg'}`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  showNotification('Gambar berhasil diunduh!', 'success');
}

// Fungsi untuk menyalin link gambar
function copyImageLink() {
  const imageLink = document.getElementById('imageLink');
  imageLink.select();
  imageLink.setSelectionRange(0, 99999);
  document.execCommand('copy');
  showNotification('Link berhasil disalin ke clipboard!', 'success');
}

// Fungsi untuk mereset semua
function resetAll() {
  images = [];
  mergedImageData = null;
  const previewContainer = document.getElementById('previewContainer');
  previewContainer.innerHTML = '';
  document.getElementById('imageCount').textContent = '0';
  const resultImage = document.getElementById('resultImage');
  resultImage.style.display = 'none';
  document.getElementById('linkContainer').style.display = 'none';
  document.getElementById('downloadBtn').style.display = 'none';
  const placeholder = document.querySelector('.placeholder');
  if (placeholder) placeholder.style.display = 'block';
  document.getElementById('mergerImageUrl').value = '';
  
  showNotification('Semua gambar telah direset', 'info');
}

// ======= EVENT LISTENERS =======
document.addEventListener('DOMContentLoaded', function() {
  // Event listeners untuk ekstraktor bukti transfer
  const imageUrlInput = document.getElementById('imageUrl');
  const userIdInput = document.getElementById('userId');
  const clearUserIdBtn = document.getElementById('clearUserId');
  const clearImageUrlBtn = document.getElementById('clearImageUrl');
  const processButton = document.getElementById('processButton');
  const resetButton = document.getElementById('resetButton');
  const uploadContainer = document.getElementById('uploadContainer');
  const fileInput = document.getElementById('fileInput');
  const themeToggle = document.getElementById('themeToggle');
  const previewContainer = document.getElementById('preview-container');
  const preview = document.getElementById('preview');
  const closePreview = document.getElementById('closePreview');
  
  // Event listeners untuk penggabung gambar
  const mergerImageUrl = document.getElementById('mergerImageUrl');
  const addUrlBtn = document.getElementById('addUrlBtn');
  const mergeBtn = document.getElementById('mergeBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const resetBtn = document.getElementById('resetBtn');
  const copyLinkBtn = document.getElementById('copyLinkBtn');
  const lightbox = document.getElementById('lightbox');
  const lightboxImg = document.getElementById('lightboxImg');
  const closeBtn = document.querySelector('.lightbox .close-btn');
  const qualitySlider = document.getElementById('quality');
  const qualityValue = document.getElementById('qualityValue');
  
  // Upload untuk penggabung gambar
  const mergerUploadContainer = document.getElementById('mergerUploadContainer');
  const mergerFileInput = document.getElementById('mergerFileInput');
  
  // Inisialisasi kualitas
  qualityValue.textContent = `${qualitySlider.value}%`;
  
  // Tab Navigasi
  document.querySelectorAll('.tab-btn').forEach(button => {
    button.addEventListener('click', () => {
      // Hapus kelas active dari semua tab dan tombol
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      // Tambahkan kelas active ke tombol yang diklik
      button.classList.add('active');
      
      // Tampilkan konten tab yang sesuai
      const tabId = button.getAttribute('data-tab');
      document.getElementById(tabId).classList.add('active');
    });
  });
  
  // Clear user ID
  if (clearUserIdBtn) {
    clearUserIdBtn.addEventListener('click', function() {
      if (userIdInput) {
        userIdInput.value = '';
        userIdInput.focus();
      }
    });
  }
  
  // Clear image URL
  if (clearImageUrlBtn) {
    clearImageUrlBtn.addEventListener('click', function() {
      if (imageUrlInput) {
        imageUrlInput.value = '';
        imageUrlInput.focus();
      }
    });
  }
  
  // Proses gambar
  if (processButton) {
    processButton.addEventListener('click', function() {
      if (!isProcessing) {
        processImage();
      }
    });
  }
  
  // Reset form
  if (resetButton) {
    resetButton.addEventListener('click', function() {
      if (userIdInput) userIdInput.value = '';
      if (imageUrlInput) imageUrlInput.value = '';
      if (document.getElementById('bankSelect')) document.getElementById('bankSelect').selectedIndex = 0;
      if (previewContainer) previewContainer.style.display = 'none';
      if (document.getElementById('resultUserId')) document.getElementById('resultUserId').textContent = '-';
      if (document.getElementById('merchantName')) document.getElementById('merchantName').textContent = '-';
      if (document.getElementById('totalAmount')) document.getElementById('totalAmount').textContent = '-';
      if (document.getElementById('rrn')) document.getElementById('rrn').textContent = '-';
      if (document.getElementById('selectedBank')) document.getElementById('selectedBank').textContent = '-';
      if (document.getElementById('imageUrlResult')) {
        document.getElementById('imageUrlResult').textContent = '-';
        document.getElementById('imageUrlResult').removeAttribute('data-full-url');
      }
      uploadedImageUrl = null;
      currentImageUrl = null;
      if (fileInput) fileInput.value = '';
      
      document.getElementById('imagePreviewModal').style.display = 'none';
    });
  }
  
  // Upload gambar untuk ekstraktor
  if (uploadContainer && fileInput) {
    uploadContainer.addEventListener('click', function() {
      fileInput.click();
    });
    
    fileInput.addEventListener('change', function(e) {
      if (e.target.files && e.target.files[0]) {
        const file = e.target.files[0];
        
        if (file.size > 5 * 1024 * 1024) {
          showNotification('Ukuran file terlalu besar. Maksimal 5MB', true);
          return;
        }
        
        const reader = new FileReader();
        
        reader.onload = function(event) {
          uploadedImageUrl = event.target.result;
          currentImageUrl = uploadedImageUrl;
          
          if (preview) {
            preview.src = uploadedImageUrl;
            previewContainer.style.display = 'block';
          }
        }
        
        reader.readAsDataURL(file);
      }
    });
  }
  
  // Upload gambar untuk penggabung
  if (mergerUploadContainer && mergerFileInput) {
    mergerUploadContainer.addEventListener('click', function() {
      mergerFileInput.click();
    });
    
    mergerFileInput.addEventListener('change', function(e) {
      if (e.target.files && e.target.files.length > 0) {
        const files = Array.from(e.target.files);
        
        // Batasi jumlah file yang diunggah
        if (images.length + files.length > 10) {
          showNotification('Maksimal 10 gambar!', 'warning');
          return;
        }
        
        files.forEach(file => {
          if (file.size > 5 * 1024 * 1024) {
            showNotification(`File ${file.name} terlalu besar. Maksimal 5MB`, true);
            return;
          }
          
          const reader = new FileReader();
          
          reader.onload = function(event) {
            const imageData = {
              src: event.target.result,
              name: file.name,
              type: 'upload'
            };
            
            images.push(imageData);
            updatePreviews();
          }
          
          reader.readAsDataURL(file);
        });
        
        showNotification('Gambar berhasil diunggah!', 'success');
      }
    });
  }
  
  // Toggle dark mode
  if (themeToggle) {
    themeToggle.addEventListener('click', function() {
      document.body.classList.toggle('dark-mode');
      
      if (document.body.classList.contains('dark-mode')) {
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        themeToggle.title = 'Mode Terang';
      } else {
        themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
        themeToggle.title = 'Mode Gelap';
      }
    });
  }
  
  // Update User ID secara real-time
  if (userIdInput) {
    userIdInput.addEventListener('input', function() {
      if (document.getElementById('resultUserId')) {
        document.getElementById('resultUserId').textContent = this.value || '-';
      }
    });
  }
  
  // Buka modal preview gambar saat klik pada gambar preview
  if (previewContainer) {
    previewContainer.addEventListener('click', function() {
      if (currentImageUrl) {
        document.getElementById('previewImage').src = currentImageUrl;
        document.getElementById('imagePreviewModal').style.display = 'block';
      }
    });
  }
  
  // Tutup modal preview gambar
  if (closePreview) {
    closePreview.addEventListener('click', function() {
      document.getElementById('imagePreviewModal').style.display = 'none';
    });
  }
  
  // Tutup modal jika klik di luar gambar
  window.addEventListener('click', function(event) {
    if (event.target === document.getElementById('imagePreviewModal')) {
      document.getElementById('imagePreviewModal').style.display = 'none';
    }
  });
  
  // Tutup modal dengan tombol ESC
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      document.getElementById('imagePreviewModal').style.display = 'none';
    }
  });
  
  // ======= EVENT LISTENERS PENGGABUNG GAMBAR =======
  
  // Tambahkan gambar dari URL
  if (addUrlBtn) {
    addUrlBtn.addEventListener('click', async function() {
      const url = mergerImageUrl.value.trim();
      if (!url) {
        showNotification('Masukkan URL gambar!', 'error');
        return;
      }
      
      if (images.length >= 10) {
        showNotification('Maksimal 10 gambar!', 'warning');
        return;
      }
      
      // Tampilkan loader
      const loader = document.getElementById('mergerLoader');
      loader.style.display = 'block';
      
      try {
        // Ekstrak URL gambar sebenarnya menggunakan teknik khusus
        const directImageUrl = await extractImageUrl(url);
        
        // Validasi URL gambar
        const img = new Image();
        img.crossOrigin = 'Anonymous';
        
        await new Promise((resolve, reject) => {
          img.onload = resolve;
          img.onerror = () => {
            reject(new Error('Gagal memuat gambar'));
          };
          img.src = directImageUrl;
        });
        
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        
        const imageData = {
          src: canvas.toDataURL('image/png'),
          name: 'url-image',
          type: 'url',
          originalUrl: url
        };
        
        images.push(imageData);
        updatePreviews();
        mergerImageUrl.value = '';
        showNotification('Gambar berhasil ditambahkan!', 'success');
      } catch (error) {
        console.error('Error:', error);
        showNotification('Gagal memuat gambar. Pastikan URL benar dan mendukung CORS.', 'error');
      } finally {
        // Sembunyikan loader
        loader.style.display = 'none';
      }
    });
  }
  
  // Tambahkan gambar saat tekan Enter
  if (mergerImageUrl) {
    mergerImageUrl.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        addUrlBtn.click();
      }
    });
  }
  
  // Merge gambar
  if (mergeBtn) {
    mergeBtn.addEventListener('click', mergeImages);
  }
  
  // Download gambar
  if (downloadBtn) {
    downloadBtn.addEventListener('click', downloadImage);
  }
  
  // Reset form
  if (resetBtn) {
    resetBtn.addEventListener('click', resetAll);
  }
  
  // Copy link
  if (copyLinkBtn) {
    copyLinkBtn.addEventListener('click', copyImageLink);
  }
  
  // Lightbox
  if (lightboxImg) {
    const resultImage = document.getElementById('resultImage');
    resultImage.addEventListener('click', () => {
      if (mergedImageData) {
        lightboxImg.src = mergedImageData;
        lightbox.style.display = 'block';
      }
    });
    
    closeBtn.addEventListener('click', () => {
      lightbox.style.display = 'none';
    });
    
    window.addEventListener('click', (e) => {
      if (e.target === lightbox) {
        lightbox.style.display = 'none';
      }
    });
  }
  
  // Kualitas
  if (qualitySlider) {
    qualitySlider.addEventListener('input', () => {
      qualityValue.textContent = `${qualitySlider.value}%`;
    });
  }
});
</script>
</body>
</html>



